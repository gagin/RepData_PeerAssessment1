---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---


## Loading and preprocessing the data

```{r}

# Directory is custom for your computer, set it correctly
setwd("~/Coursera-R/RepData_PeerAssessment1/")

# Original Github branch has the data zipped, let's extract it
if(!file.exists("activity.csv")) unzip("activity.zip")

# read the file
data<-read.csv("activity.csv")

# Later we will need to have intervals as actual time for charts,
# so let us make them uniform to ease strptime conversion
data$interval<-sapply(data$interval,
                      function(i){
                              i.length<-nchar(as.character(i))
                              if(i.length<4){
                                prefix<-paste(rep(0,4-i.length),collapse="")
                                paste0(prefix,i)}
                              else i
                              }
                      )
data$date<-as.Date(data$date,"%Y-%m-%d")

```

## What is mean total number of steps taken per day?

```{r}
sum<-tapply(data$steps,
            data$date,
            sum,
            na.rm=TRUE)
hist(sum,
     xlab="Daily steps taken",
     main="",
     breaks=10)
summary(sum)
```


Mean is `r summary(sum)["Mean"]`, median is `r as.integer(summary(sum)["Median"])`.

## What is the average daily activity pattern?


```{r}
pattern<-tapply(data$steps,
                data$interval,
                mean,
                na.rm=TRUE)

# Convert interval to times to make x labels more meaningful

plot(strptime(names(pattern),"%H%M"),
     pattern/5,
     type="l",
     xlab="Time of day",  
     ylab="Average steps per minute")

which.max(pattern)
```

The most step usually happen in five minutes that start on
`r format(strptime(names(which.max(pattern)),"%H%M"),"%H:%M")`.


## Imputing missing values

Calculate the total number of missing values in the dataset
```{r}
sum(is.na(data))
```

Let's replace NAs with average value for the interval and make a new dataset.

```{r}
d<-data
d$steps<-sapply(seq_along(d$steps),
                function(n){
                  if(is.na(d$steps[n])){
                          pattern[names(pattern)==d$interval[n]]
                  } else d$steps[n]
                  }
                  )
```

```{r echo=FALSE, eval=FALSE }
# Just to be sure, let us see than the pattern hasn't changed
pattern1<-tapply(d$steps,
                d$interval,
                mean,
                na.rm=TRUE)
identical(pattern,pattern1)
```

Now, if we rebuild the histogram, we should expect number of steps,
as well as median and mean, to go up.

```{r}
sum1<-tapply(d$steps,
            d$date,
            sum,
            na.rm=TRUE)
hist(sum1,
     xlab="Daily steps taken (with NAs replaced)",
     main="",
     breaks=10)
summary(sum1)
```

And they did.


## Are there differences in activity patterns between weekdays and weekends?

```{r}
weekpart<-function(dt){if(weekdays(dt) %in% c("Saturday","Sunday")) "weekend" else "weekday"}
weekpart<-sapply(d$date,weekpart)
d<-cbind(d,weekpart)

#library(ggplot2)
#p1<-ggplot(data=d,aes(x=interval,y=steps,color=weekpart))#+geom_line()
#p1<-qplot(sapply(interval,strptime,"%H%M"),steps,data=d,group=weekpart,geom="line")
#print(p1)
#hist_comp<-barchart(steps ~ interval | weekends, data=d)
#print(hist_comp)
library(dplyr)
patternw<-d %>% group_by(interval,weekpart) %>% summarise(mean(steps))
#patternw$interval<-strptime(patternw$interval,"%H%M")
names(patternw)[3]<-"steps"
patternw$interval<-strptime(patternw$interval,"%H%M")
library(lattice)
print(xyplot(steps ~ interval | weekpart, data=patternw, layout=1:2,
             ylab="Number of steps", type="l"))
#p2<-qplot(interval,steps,group=weekpart,color=weekpart,geom="line",data=patternw)
#print(p2)
#dailyw<- d%>% group_by(date,weekpart) %>% summarise(sum(steps))
#names(dailyw)[3]<-"steps"
#p3<-qplot(steps,group=weekpart,color=weekpart,geom="histogram",data=patternw)
#print(p3)
```
